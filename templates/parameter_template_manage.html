{% extends "base.html" %}

{% block title %}Manage Template: {{ template.name }} - Inventory Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 offset-md-1">
        <h2>Manage Parameter Template</h2>
        
        <!-- Template Details -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Template Details</h5>
            </div>
            <div class="card-body">
                <h5 class="card-title">{{ template.name }}</h5>
                <p class="card-text">{{ template.description or 'No description' }}</p>
                
                <div class="mt-3">
                    <a href="{{ url_for('magic_parameter.parameter_template_edit', id=template.id) }}" class="btn btn-warning">
                        <i class="bi bi-pencil"></i> Edit Template
                    </a>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addParameterModal">
                        <i class="bi bi-plus-circle"></i> Add Parameter
                    </button>
                    <a href="{{ url_for('magic_parameter.magic_parameters') }}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Back
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Template Parameters -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Template Parameters</h5>
            </div>
            <div class="card-body">
                {% if template.template_parameters %}
                <div class="list-group">
                    {% for param in template.template_parameters|sort(attribute='display_order') %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <p class="mb-1">{{ param.get_display_text() }}</p>
                                {% if param.parameter.param_type == 'date' and param.parameter.notify_enabled %}
                                <i class="bi bi-bell-fill text-warning" title="Notifications enabled"></i>
                                {% endif %}
                            </div>
                            <div>
                                <form method="POST" action="{{ url_for('magic_parameter.template_delete_parameter', template_id=template.id, param_id=param.id) }}" 
                                      style="display: inline;">
                                    <button type="submit" class="btn btn-sm btn-danger" 
                                            onclick="return confirm('Remove this parameter from template?')" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No parameters in this template. Click 'Add Parameter' to add parameters.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Parameter Modal (same as item_form.html but for template) -->
<div class="modal fade" id="addParameterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('magic_parameter.template_add_parameter', id=template.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">Add Parameter to Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Same fields as item parameter modal -->
                    <!-- Parameter Type Selection -->
                    <div class="mb-3">
                        <label class="form-label">Parameter Type</label>
                        <select name="param_type" id="modal_param_type" class="form-select" onchange="updateParameterFields()">
                            <option value="">-- Select Type --</option>
                            <option value="number">Number</option>
                            <option value="date">Date</option>
                            <option value="string">String</option>
                        </select>
                    </div>
                    
                    <!-- Parameter Selection -->
                    <div class="mb-3">
                        <label class="form-label">Parameter</label>
                        <select name="parameter_id" id="modal_parameter_id" class="form-select" onchange="updateParameterOptions()">
                            <option value="">-- Select Parameter --</option>
                        </select>
                    </div>
                    
                    <!-- Operation Selection (for Number and Date types) -->
                    <div class="mb-3" id="operation_group" style="display: none;">
                        <label class="form-label">Operation</label>
                        <select name="operation" id="modal_operation" class="form-select" onchange="updateValueFields()">
                            <option value="">-- Select Operation --</option>
                        </select>
                    </div>
                    
                    <!-- Value Fields -->
                    <div class="row" id="value_fields" style="display: none;">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label" id="value1_label">Value</label>
                                <input type="text" name="value" id="modal_value" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6" id="value2_group" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label" id="value2_label">Second Value</label>
                                <input type="text" name="value2" id="modal_value2" class="form-control">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Unit Selection (for Number type) -->
                    <div class="mb-3" id="unit_group" style="display: none;">
                        <label class="form-label">Unit</label>
                        <select name="unit" id="modal_unit" class="form-select">
                            <option value="">-- Select Unit --</option>
                        </select>
                    </div>
                    
                    <!-- String Option Selection (for String type) -->
                    <div class="mb-3" id="string_option_group" style="display: none;">
                        <label class="form-label">Option</label>
                        <select name="string_option" id="modal_string_option" class="form-select">
                            <option value="">-- Select Option --</option>
                        </select>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        <textarea name="description" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Parameter</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Same JavaScript functions as item_form.html
function updateParameterFields() {
    const paramType = document.getElementById('modal_param_type').value;
    const paramSelect = document.getElementById('modal_parameter_id');
    
    paramSelect.innerHTML = '<option value="">-- Select Parameter --</option>';
    
    document.getElementById('operation_group').style.display = 'none';
    document.getElementById('value_fields').style.display = 'none';
    document.getElementById('unit_group').style.display = 'none';
    document.getElementById('string_option_group').style.display = 'none';
    
    if (paramType) {
        fetch(`/api/magic-parameters/${paramType}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(param => {
                    const option = new Option(param.name, param.id);
                    paramSelect.add(option);
                });
            });
    }
}

function updateParameterOptions() {
    const paramType = document.getElementById('modal_param_type').value;
    const parameterId = document.getElementById('modal_parameter_id').value;
    
    if (!parameterId) return;
    
    if (paramType === 'number') {
        document.getElementById('operation_group').style.display = 'block';
        const operationSelect = document.getElementById('modal_operation');
        operationSelect.innerHTML = `
            <option value="">-- Select Operation --</option>
            <option value="min">Min</option>
            <option value="max">Max</option>
            <option value="value">Value</option>
            <option value="range">Range</option>
        `;
        
        fetch(`/api/magic-parameters/number`)
            .then(response => response.json())
            .then(data => {
                const param = data.find(p => p.id == parameterId);
                if (param && param.units) {
                    const unitSelect = document.getElementById('modal_unit');
                    unitSelect.innerHTML = '<option value="">-- Select Unit --</option>';
                    param.units.forEach(unit => {
                        const option = new Option(unit, unit);
                        unitSelect.add(option);
                    });
                    document.getElementById('unit_group').style.display = 'block';
                }
            });
    } else if (paramType === 'date') {
        document.getElementById('operation_group').style.display = 'block';
        const operationSelect = document.getElementById('modal_operation');
        operationSelect.innerHTML = `
            <option value="">-- Select Operation --</option>
            <option value="start">Start</option>
            <option value="end">End</option>
            <option value="value">Value</option>
            <option value="duration">Duration</option>
        `;
    } else if (paramType === 'string') {
        fetch(`/api/magic-parameters/string`)
            .then(response => response.json())
            .then(data => {
                const param = data.find(p => p.id == parameterId);
                if (param && param.options) {
                    const optionSelect = document.getElementById('modal_string_option');
                    optionSelect.innerHTML = '<option value="">-- Select Option --</option>';
                    param.options.forEach(opt => {
                        const option = new Option(opt, opt);
                        optionSelect.add(option);
                    });
                    document.getElementById('string_option_group').style.display = 'block';
                }
            });
    }
}

function updateValueFields() {
    const paramType = document.getElementById('modal_param_type').value;
    const operation = document.getElementById('modal_operation').value;
    
    if (!operation) {
        document.getElementById('value_fields').style.display = 'none';
        return;
    }
    
    document.getElementById('value_fields').style.display = 'block';
    
    if (paramType === 'date') {
        document.getElementById('modal_value').type = 'date';
        document.getElementById('modal_value2').type = 'date';
        
        if (operation === 'duration') {
            document.getElementById('value1_label').textContent = 'Start Date';
            document.getElementById('value2_label').textContent = 'End Date';
            document.getElementById('value2_group').style.display = 'block';
        } else {
            document.getElementById('value1_label').textContent = 'Date';
            document.getElementById('value2_group').style.display = 'none';
        }
    } else if (paramType === 'number') {
        document.getElementById('modal_value').type = 'text';
        document.getElementById('modal_value2').type = 'text';
        
        if (operation === 'range') {
            document.getElementById('value1_label').textContent = 'Min Value';
            document.getElementById('value2_label').textContent = 'Max Value';
            document.getElementById('value2_group').style.display = 'block';
        } else {
            document.getElementById('value1_label').textContent = 'Value';
            document.getElementById('value2_group').style.display = 'none';
        }
    }
}
</script>

{% endblock %}
