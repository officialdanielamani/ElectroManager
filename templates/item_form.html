{% extends "base.html" %}

{% block title %}{{ title }} - Inventory Manager{% endblock %}

{% block content %}

{% if item_perms and not (item_perms.can_edit_name and item_perms.can_edit_sku_type and item_perms.can_edit_description and item_perms.can_edit_price and item_perms.can_edit_quantity and item_perms.can_edit_location and item_perms.can_edit_category and item_perms.can_edit_footprint and item_perms.can_edit_tags and item_perms.can_edit_parameters) %}
<div class="alert alert-info alert-dismissible fade show" role="alert">
    <strong><i class="bi bi-info-circle"></i> Limited Editing Permissions</strong><br>
    <small>You can only edit: 
    {% set editable_sections = [] %}
    {% if item_perms.can_edit_name %}{{ editable_sections.append('Name') or '' }}{% endif %}
    {% if item_perms.can_edit_sku_type %}{{ editable_sections.append('SKU & Type') or '' }}{% endif %}
    {% if item_perms.can_edit_description %}{{ editable_sections.append('Description') or '' }}{% endif %}
    {% if item_perms.can_edit_price %}{{ editable_sections.append('Price') or '' }}{% endif %}
    {% if item_perms.can_edit_quantity %}{{ editable_sections.append('Qty & Min Qty') or '' }}{% endif %}
    {% if item_perms.can_edit_location %}{{ editable_sections.append('Location') or '' }}{% endif %}
    {% if item_perms.can_edit_category %}{{ editable_sections.append('Category') or '' }}{% endif %}
    {% if item_perms.can_edit_footprint %}{{ editable_sections.append('Footprint') or '' }}{% endif %}
    {% if item_perms.can_edit_tags %}{{ editable_sections.append('Tags') or '' }}{% endif %}
    {% if item_perms.can_edit_parameters %}{{ editable_sections.append('Magic Parameters') or '' }}{% endif %}
    {{ editable_sections|join(', ') }}
    </small>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-box"></i> {{ title }}</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="itemForm">
                    {{ form.hidden_tag() }}

                    <!-- Row 1: Name and SKU -->
                    <div class="row mb-2">
                        <div class="col-8">
                            <label class="form-label form-label-sm">Component Name *</label>
                            {{ form.name(class="form-control form-control-sm" + (" is-invalid" if form.name.errors else
                            ""), disabled=(item_perms and not item_perms.can_edit_name)) }}
                        </div>
                        <div class="col-4">
                            <label class="form-label form-label-sm">SKU</label>
                            {{ form.sku(class="form-control form-control-sm", disabled=(item_perms and not item_perms.can_edit_sku_type)) }}
                        </div>
                    </div>

                    <!-- Row 2: Type/Model and Description -->
                    <div class="row mb-2">
                        <div class="col-6">
                            <label class="form-label form-label-sm">Type / Model</label>
                            {{ form.info(class="form-control form-control-sm", placeholder="eg TVS Diode", disabled=(item_perms and not item_perms.can_edit_sku_type)) }}
                        </div>
                    </div>

                    <div class="mb-2">
                        <label class="form-label form-label-sm">Description</label>
                        {{ form.description(class="form-control form-control-sm", placeholder="Support Markdown format", rows=4, disabled=(item_perms and not item_perms.can_edit_description)) }}
                    </div>

                    <!-- Row 3: Category and Quantity -->
                    <div class="row mb-2">
                        <div class="col-8">
                            <label class="form-label form-label-sm">Category</label>
                            <div class="input-group input-group-sm">
                                {{ form.category_id(class="form-select form-select-sm", disabled=(item_perms and not item_perms.can_edit_category)) }}
                                <button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#addCategoryModal"
                                    {% if item_perms and not item_perms.can_edit_category %}disabled{% endif %}>
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-4">
                            <label class="form-label form-label-sm">Quantity *</label>
                            {{ form.quantity(class="form-control form-control-sm", min="0", step="1", required=True, disabled=(item_perms and not item_perms.can_edit_quantity)) }}
                        </div>
                    </div>

                    <!-- Row 4: Price and Total -->
                    <div class="row mb-2">
                        <div class="col-6">
                            <label class="form-label form-label-sm">Price per Qty ({{ currency }})</label>
                            {{ form.price(class="form-control form-control-sm", placeholder="0.00", id="price_per_qty", disabled=(item_perms and not item_perms.can_edit_price)) }}
                        </div>
                        <div class="col-6">
                            <label class="form-label form-label-sm">Total Price ({{ currency }})</label>
                            <input type="text" class="form-control form-control-sm" id="total_price" readonly
                                style="background-color: #e9ecef; font-weight: bold;" value="0.00">
                        </div>
                    </div>

                    <!-- Row 4b: No Stock Warning -->
                    <div class="row mb-2">
                        <div class="col-12">
                            <div class="form-check">
                                {% if item %}
                                    <input type="checkbox" class="form-check-input" id="no_stock_warning" name="no_stock_warning" value="y" {% if item.no_stock_warning %}checked{% endif %}
                                        {% if item_perms and not item_perms.can_edit_quantity %}disabled{% endif %}>
                                {% else %}
                                    <input type="checkbox" class="form-check-input" id="no_stock_warning" name="no_stock_warning" value="y" checked
                                        {% if item_perms and not item_perms.can_edit_quantity %}disabled{% endif %}>
                                {% endif %}
                                <label class="form-check-label" for="no_stock_warning">
                                    Enable No Stock Warning
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Physical Storage Location -->
                    <div class="card bg-light mb-2">
                        <div class="card-body p-2">
                            <label class="form-label form-label-sm mb-2"><strong>Physical Storage
                                    Location</strong></label>

                            <!-- Storage Type -->
                            <div class="btn-group btn-group-sm w-100 mb-2" role="group">
                                <input type="radio" class="btn-check" name="location_type" id="type_general"
                                    value="general" {% if not item or (item and not item.rack_id) %}checked{% endif %}
                                    {% if item_perms and not item_perms.can_edit_location %}disabled{% endif %}>
                                <label class="btn btn-outline-primary" for="type_general">General Location</label>

                                <input type="radio" class="btn-check" name="location_type" id="type_drawer"
                                    value="drawer" {% if item and item.rack_id %}checked{% endif %}
                                    {% if item_perms and not item_perms.can_edit_location %}disabled{% endif %}>
                                <label class="btn btn-outline-primary" for="type_drawer">Drawer Storage</label>
                            </div>

                            <!-- General Location -->
                            <div id="general_location_section">
                                <label class="form-label form-label-sm">General Location</label>
                                <div class="input-group input-group-sm mb-2">
                                    {{ form.location_id(class="form-select form-select-sm", disabled=(item_perms and not item_perms.can_edit_location)) }}
                                    <button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal"
                                        data-bs-target="#addLocationModal"
                                        {% if item_perms and not item_perms.can_edit_location %}disabled{% endif %}>
                                        <i class="bi bi-plus-circle"></i>
                                    </button>
                                </div>
                                <small class="text-muted d-block">Choose from existing locations or create new</small>
                            </div>

                            <!-- Drawer Storage -->
                            <div id="drawer_storage_section" style="display: none;">
                                <!-- Compact Row: Location | Rack | Drawer -->
                                <div class="row g-2 mb-2" style="position: relative;">
                                    <div class="col-4" style="overflow: visible;">
                                        <label class="form-label form-label-sm">Location</label>
                                        <select name="storage_location_id" id="storage_location_select" class="form-select form-select-sm" onchange="updateStorageRackSelect()" style="position: relative; z-index: 100;"
                                            {% if item_perms and not item_perms.can_edit_location %}disabled{% endif %}>
                                            <option value="">All</option>
                                            {% for loc in locations %}
                                            <option value="{{ loc.id }}">{{ loc.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-4" style="overflow: visible;">
                                        <label class="form-label form-label-sm">Rack</label>
                                        <select name="rack_id" id="rack_select" class="form-select form-select-sm" onchange="updateDrawerGrid()" style="position: relative; z-index: 99;"
                                            {% if item_perms and not item_perms.can_edit_location %}disabled{% endif %}>
                                            <option value="">Select</option>
                                            {% for rack in racks %}
                                            <option value="{{ rack.id }}" data-rows="{{ rack.rows }}"
                                                data-cols="{{ rack.cols }}" data-location="{{ rack.physical_location.id if rack.physical_location else '' }}" {% if item and item.rack_id==rack.id
                                                %}selected{% endif %}>
                                                {{ rack.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-4" style="overflow: visible;">
                                        <label class="form-label form-label-sm">Drawer</label>
                                        {{ form.drawer(class="form-control form-control-sm", id="drawer_input", placeholder="Select", readonly=True, disabled=(item_perms and not item_perms.can_edit_location)) }}
                                    </div>
                                </div>

                                <!-- Visual Drawer Picker -->
                                <div id="drawer_picker" style="display: none;">
                                    <div class="p-2 border rounded drawer-grid-container">
                                        <small class="text-muted d-block mb-2">Click to select:</small>
                                        <div id="drawer_grid" style="display: inline-grid; gap: 4px; background: transparent;"></div>
                                    </div>
                                </div>

                                <small class="text-muted d-block">Precise cell-level organization</small>
                            </div>
                        </div>
                    </div>

                    <!-- Footprint -->
                    <div class="mb-2">
                        <label class="form-label form-label-sm">Footprint</label>
                        <div class="input-group input-group-sm">
                            {{ form.footprint_id(class="form-select form-select-sm", disabled=(item_perms and not item_perms.can_edit_footprint)) }}
                            <button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal"
                                data-bs-target="#addFootprintModal"
                                {% if item_perms and not item_perms.can_edit_footprint %}disabled{% endif %}>
                                <i class="bi bi-plus-circle"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Tags - Compact Multi-select -->
                    <div class="mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <label class="form-label form-label-sm mb-0">Tags</label>
                            <button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal"
                                data-bs-target="#addTagModal" {% if item_perms and not item_perms.can_edit_tags %}disabled{% endif %}>
                                <i class="bi bi-plus-circle"></i> Add Tag
                            </button>
                        </div>
                        <div class="border rounded p-2 mt-1" style="max-height: 120px; overflow-y: auto;"
                            id="tagsContainer">
                            {% for tag in all_tags %}
                            <div class="form-check form-check-inline" style="min-width: 150px;">
                                <input class="form-check-input" type="checkbox" name="tags[]" value="{{ tag.id }}"
                                    id="tag{{ tag.id }}" {% if item and tag.id in
                                    item.get_tags_list()|map(attribute='id')|list %}checked{% endif %}
                                    {% if item_perms and not item_perms.can_edit_tags %}disabled{% endif %}>
                                <label class="form-check-label" for="tag{{ tag.id }}">
                                    <span class="badge"
                                        style="background-color: {{ tag.color }}; font-size: 0.75rem;">{{ tag.name
                                        }}</span>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Upload Files Section (only shown when editing) -->
                    {% if item %}
                    <div class="mb-3 border-top pt-3">
                        <label class="form-label form-label-sm">
                            <i class="bi bi-upload"></i> Upload Files / Pictures
                        </label>

                        <!-- Existing Files Preview -->
                        {% set images = item.attachments | selectattr('file_type', 'in', ['png', 'jpg', 'jpeg', 'gif',
                        'webp']) | list %}
                        {% set other_files = item.attachments | rejectattr('file_type', 'in', ['png', 'jpg', 'jpeg',
                        'gif', 'webp']) | list %}

                        {% if images or other_files %}
                        <div class="mb-2">
                            <small class="text-muted">Current Files:</small>

                            <!-- Image Previews -->
                            {% if images %}
                            <div class="mt-2 mb-2">
                                <strong class="small">Images:</strong>
                                <div class="d-flex flex-wrap gap-2 mt-1">
                                    {% for att in images %}
                                    <div class="position-relative" style="width: 100px; height: 100px;">
                                        <img src="{{ url_for('uploaded_file', filename=att.filename) }}"
                                            class="img-thumbnail"
                                            style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;"
                                            alt="{{ att.original_filename }}" title="Click to view"
                                            onclick="openImageEditModal('{{ url_for('uploaded_file', filename=att.filename) }}', '{{ att.original_filename }}', {{ att.id }})">
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- Other Files List -->
                            {% if other_files %}
                            <div class="mt-2">
                                <strong class="small">Other Files:</strong>
                                <div class="list-group mt-1">
                                    {% for att in other_files %}
                                    <div class="list-group-item p-2 d-flex justify-content-between align-items-center">
                                        <small>
                                            <i class="bi bi-file-earmark"></i> {{ att.original_filename }}
                                            <span class="text-muted">({{ "%.2f"|format(att.file_size / 1024 / 1024) }}
                                                MB)</span>
                                        </small>
                                        <div>
                                            <button type="button" class="btn btn-warning btn-sm"
                                                style="padding: 0.1rem 0.4rem; font-size: 0.75rem;"
                                                onclick="openFileRenameModal({{ att.id }}, '{{ att.original_filename }}')"
                                                {% if item_perms and not item_perms.can_edit_upload %}disabled{% endif %}>
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button" class="btn btn-danger btn-sm"
                                                style="padding: 0.1rem 0.4rem; font-size: 0.75rem;"
                                                onclick="deleteFile({{ att.id }})"
                                                {% if item_perms and not item_perms.can_edit_upload %}disabled{% endif %}>
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Upload New Files Form -->
                        <div class="card bg-light">
                            <div class="card-body p-2">
                                <div id="uploadFormContainer">
                                    <div class="mb-2">
                                        <label class="form-label form-label-sm">Select Files to Upload:</label>
                                        <input type="file" id="fileUploadInput" class="form-control form-control-sm"
                                            multiple {% if item_perms and not item_perms.can_edit_upload %}disabled{% endif %}>
                                        <small class="text-muted">Allowed: {{ allowed_file_types }} | Max: {{
                                            max_file_size_mb }}MB per file</small>
                                    </div>
                                    <button type="button" class="btn btn-primary btn-sm" onclick="uploadFiles()" {% if item_perms and not item_perms.can_edit_upload %}disabled{% endif %}>
                                        <i class="bi bi-upload"></i> Upload Files
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}





                    <!-- Magic Parameters Section (only shown when editing) -->
                    {% if item %}
                    <div class="mb-3 border-top pt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label form-label-sm mb-0">
                                <i class="bi bi-magic"></i> Magic Parameters
                            </label>
                            <div>
                                <button type="button" id="addParameterBtn" class="btn btn-sm btn-success" data-bs-toggle="modal"
                                    data-bs-target="#addParameterModal" {% if item_perms and not item_perms.can_edit_parameters %}disabled{% endif %}>
                                    <i class="bi bi-plus-circle"></i> Add Parameter
                                </button>
                                <button type="button" id="useTemplateBtn" class="btn btn-sm btn-success ms-1" data-bs-toggle="modal"
                                    data-bs-target="#useTemplateModal" {% if item_perms and not item_perms.can_edit_parameters %}disabled{% endif %}>
                                    <i class="bi bi-collection"></i> Use Template
                                </button>
                            </div>
                        </div>

                        <div id="magic-parameters-list">
                            {% if item.magic_parameters %}
                            <div class="list-group mt-2">
                                {% for param in item.magic_parameters %}
                                <div class="list-group-item p-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="flex-grow-1">
                                            <small class="text-muted">
                                                {% if param.parameter.param_type == 'number' %}
                                                {% if param.operation == 'min' %}MIN{% elif param.operation == 'max'
                                                %}MAX{% elif param.operation == 'range' %}RANGE{% elif param.operation
                                                == 'value' %}VALUE{% endif %}:
                                                {% elif param.parameter.param_type == 'date' %}
                                                {% if param.operation == 'start' %}START{% elif param.operation == 'end'
                                                %}END{% elif param.operation == 'duration' %}DURATION{% endif %}{% if
                                                param.operation == 'value' %}{% endif %}
                                                {% endif %}
                                                <strong>{{ param.parameter.name }}</strong>
                                                {% if param.parameter.param_type == 'number' %}
                                                {{ param.value }} {% if param.operation == 'range' %}- {{ param.value2
                                                }}{% endif %} {{ param.unit }}
                                                {% elif param.parameter.param_type == 'date' %}
                                                {% if param.operation != 'value' %}on {% endif %}{{ param.value }} {% if
                                                param.operation == 'duration' %}to {{ param.value2 }}{% endif %}
                                                {% elif param.parameter.param_type == 'string' %}
                                                {{ param.string_option }}
                                                {% endif %}
                                                {% if param.description %}{{ param.description }}{% endif %}
                                                {% if param.parameter.param_type == 'date' and
                                                param.parameter.notify_enabled %}
                                                <i class="bi bi-bell-fill text-warning"
                                                    title="Notifications enabled"></i>
                                                {% endif %}
                                            </small>
                                        </div>
                                        <div>
                                            <a href="{{ url_for('item.item_edit_parameter', item_id=item.id, param_id=param.id) }}"
                                                class="btn btn-sm btn-warning btn-sm" title="Edit"
                                                {% if item_perms and not item_perms.can_edit_parameters %}onclick="event.preventDefault(); alert('You do not have permission to edit parameters.'); return false;"{% endif %}>
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-danger btn-sm"
                                                onclick="submitDeleteParameterForm({{ item.id }}, {{ param.id }}, event)"
                                                title="Delete"
                                                {% if item_perms and not item_perms.can_edit_parameters %}disabled{% endif %}>
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-muted small mt-2">No parameters added. Click 'Add Parameter' or 'Use
                                Template' to add parameters.</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Datasheet URLs - New Interface -->
                    <div class="mb-3">
                        <label class="form-label form-label-sm">Datasheet URLs</label>
                        <button type="button" class="btn btn-sm btn-primary float-end" onclick="addDatasheetRow()"
                            {% if item_perms and not item_perms.can_edit_datasheet %}disabled{% endif %}>
                            <i class="bi bi-plus-circle"></i> Add URL
                        </button>
                        <div id="datasheet-list" class="mt-2">
                            <!-- Datasheet entries will be shown here -->
                        </div>
                        <!-- Hidden field to store JSON data -->
                        {{ form.datasheet_urls(id="datasheet_urls_hidden", style="display:none;") }}
                    </div>

                    <script>
                        // Ensure datasheet URLs are updated before the main form is submitted
                        document.getElementById('itemForm').addEventListener('submit', function (e) {
                            updateHiddenField(); // Call the function to ensure the hidden field is current
                            // Optional: Log the value being submitted for debugging
                            // console.log("Submitting datasheet URLs:", document.getElementById('datasheet_urls_hidden').value);
                        });

                        // Store datasheet data for form
                        let formDatasheets = [];
                        
                        // Check if user has permission to edit datasheets
                        const canEditDatasheet = {% if item_perms and item_perms.can_edit_datasheet %}true{% else %}false{% endif %};

                        // Load existing datasheets
                        {% if form.datasheet_urls.data %}
                        try {
                            formDatasheets = JSON.parse('{{ form.datasheet_urls.data|safe }}');
                        } catch (e) {
                            // Handle old format (plain URLs)
                            const oldUrls = `{{ form.datasheet_urls.data|safe }}`.split('\n').filter(u => u.trim());
                            formDatasheets = oldUrls.map(url => ({ url: url.trim(), title: '', info: '' }));
                        }
                        {% endif %}

                        function renderFormDatasheets() {
                            const container = document.getElementById('datasheet-list');
                            if (!container) return;

                            if (formDatasheets.length === 0) {
                                container.innerHTML = '<p class="text-muted small mb-0">No datasheets added. Click "Add URL" to add one.</p>';
                                return;
                            }

                            let html = '';
                            formDatasheets.forEach((ds, index) => {
                                const displayTitle = ds.title || ds.url;

                                html += `<div class="border rounded p-2 mb-2 bg-light" id="form-ds-${index}">`;

                                // Display mode
                                html += `<div class="form-ds-display-${index}">`;
                                html += `<i class="bi bi-link-45deg text-primary"></i> `;
                                html += `<strong>${displayTitle}</strong>`;
                                if (ds.info) {
                                    html += ` <span class="text-muted">- ${ds.info}</span>`;
                                }
                                html += ` <button type="button" class="btn btn-sm btn-outline-primary btn-sm ms-2" onclick="editFormDatasheet(${index})" ${!canEditDatasheet ? 'disabled' : ''}>Edit</button>`;
                                html += ` <button type="button" class="btn btn-sm btn-outline-danger btn-sm" onclick="deleteFormDatasheet(${index})" ${!canEditDatasheet ? 'disabled' : ''}>Delete</button>`;
                                html += `</div>`;

                                // Edit mode
                                html += `<div class="form-ds-edit-${index}" style="display:none;">`;
                                html += `<div class="row g-2">`;
                                html += `<div class="col-md-4">`;
                                html += `<input type="text" class="form-control form-control-sm" id="form-url-${index}" value="${ds.url}" placeholder="URL (required)">`;
                                html += `<small class="text-muted">e.g., example.com</small>`;
                                html += `</div>`;
                                html += `<div class="col-md-4">`;
                                html += `<input type="text" class="form-control form-control-sm" id="form-title-${index}" value="${ds.title}" placeholder="Title (optional)">`;
                                html += `<small class="text-muted">Display name</small>`;
                                html += `</div>`;
                                html += `<div class="col-md-4">`;
                                html += `<input type="text" class="form-control form-control-sm" id="form-info-${index}" value="${ds.info}" placeholder="Info (optional)">`;
                                html += `<small class="text-muted">Additional info</small>`;
                                html += `</div>`;
                                html += `</div>`;
                                html += `<div class="mt-2">`;
                                html += `<button type="button" class="btn btn-sm btn-success" onclick="saveFormDatasheet(${index})"><i class="bi bi-check"></i> Save</button> `;
                                html += `<button type="button" class="btn btn-sm btn-secondary" onclick="cancelFormEdit(${index})"><i class="bi bi-x"></i> Cancel</button>`;
                                html += `</div>`;
                                html += `</div>`;

                                html += `</div>`;
                            });

                            container.innerHTML = html;

                            // Update hidden field
                            updateHiddenField();
                        }

                        function updateHiddenField() {
                            const hiddenField = document.getElementById('datasheet_urls_hidden');
                            if (hiddenField) {
                                hiddenField.value = JSON.stringify(formDatasheets);
                            }
                        }

                        function addDatasheetRow() {
                            formDatasheets.push({ url: '', title: '', info: '' });
                            renderFormDatasheets();
                            const newIndex = formDatasheets.length - 1;
                            editFormDatasheet(newIndex);
                        }

                        function editFormDatasheet(index) {
                            document.querySelector(`.form-ds-display-${index}`).style.display = 'none';
                            document.querySelector(`.form-ds-edit-${index}`).style.display = 'block';
                        }

                        function cancelFormEdit(index) {
                            // If it's a new empty entry, remove it
                            if (!formDatasheets[index].url && !formDatasheets[index].title) {
                                formDatasheets.splice(index, 1);
                                renderFormDatasheets();
                                return;
                            }

                            document.querySelector(`.form-ds-display-${index}`).style.display = 'block';
                            document.querySelector(`.form-ds-edit-${index}`).style.display = 'none';
                        }

                        function saveFormDatasheet(index) {
                            const url = document.getElementById(`form-url-${index}`).value.trim();
                            const title = document.getElementById(`form-title-${index}`).value.trim();
                            const info = document.getElementById(`form-info-${index}`).value.trim();

                            if (!url) {
                                alert('URL is required!');
                                return;
                            }

                            // Add protocol if missing
                            let finalUrl = url;
                            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                                finalUrl = 'https://' + url;
                            }

                            formDatasheets[index] = { url: finalUrl, title: title, info: info };
                            renderFormDatasheets();
                        }

                        function deleteFormDatasheet(index) {
                            if (!confirm('Delete this datasheet URL?')) return;
                            formDatasheets.splice(index, 1);
                            renderFormDatasheets();
                        }

                        function submitDeleteParameterForm(itemId, paramId, event) {
                            event.preventDefault();
                            event.stopImmediatePropagation();

                            if (!confirm('Remove this parameter?')) return;

                            // Create a temporary form to submit the delete request
                            const tempForm = document.createElement('form');
                            tempForm.method = 'POST';
                            tempForm.action = `/item/${itemId}/delete-parameter/${paramId}`;

                            // Add CSRF token if it exists
                            const csrfToken = document.querySelector('input[name="csrf_token"]');
                            if (csrfToken) {
                                const tokenInput = document.createElement('input');
                                tokenInput.type = 'hidden';
                                tokenInput.name = 'csrf_token';
                                tokenInput.value = csrfToken.value;
                                tempForm.appendChild(tokenInput);
                            }

                            document.body.appendChild(tempForm);
                            tempForm.submit();
                        }

                        // Initial render
                        document.addEventListener('DOMContentLoaded', function () {
                            renderFormDatasheets();

                            // Main form submit handler - just update the hidden field before submit
                            const mainForm = document.getElementById('itemForm');
                            if (mainForm) {
                                mainForm.addEventListener('submit', function (e) {
                                    // Update datasheet JSON before form submission
                                    updateHiddenField();
                                    // Allow form to submit normally
                                    return true;
                                });
                            }
                        });
                    </script>

                    <!-- UUID and Min Quantity -->
                    <div class="row mb-2">
                        <div class="col-6">
                            <label class="form-label form-label-sm">UUID</label>
                            <input type="text" class="form-control form-control-sm"
                                value="{{ item.uuid if item else 'Auto-generated' }}" readonly>
                        </div>
                        <div class="col-6">
                            <label class="form-label form-label-sm">Min Quantity</label>
                            {{ form.min_quantity(class="form-control form-control-sm", placeholder="0", disabled=(item_perms and not item_perms.can_edit_quantity)) }}
                        </div>
                    </div>

                    <!-- Lending Section -->
                    <div class="card bg-warning bg-opacity-10 mb-3">
                        <div class="card-body p-2">
                            <label class="form-label form-label-sm mb-2"><strong>Lending (Optional)</strong></label>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label form-label-sm">Lend To</label>
                                    {{ form.lend_to(class="form-control form-control-sm", id="lend_to_input", disabled=(item_perms and not item_perms.can_edit_lending)) }}
                                </div>
                                <div class="col-6" id="lend_qty_section" style="display: none;">
                                    <label class="form-label form-label-sm">Lend Quantity</label>
                                    {{ form.lend_quantity(class="form-control form-control-sm", id="lend_qty_input", disabled=(item_perms and not item_perms.can_edit_lending)) }}
                                    <small class="text-danger" id="lend_error"></small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('item.items') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Image Edit Modal -->
<div class="modal fade" id="imageEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Image Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <img id="modalImagePreview" src="" class="img-fluid" style="max-height: 400px;" alt="">
                </div>
                <div class="mb-3">
                    <label class="form-label">File Name:</label>
                    <input type="text" id="imageFileName" class="form-control" value="">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="deleteImageFromModal()"
                    {% if item_perms and not item_perms.can_edit_upload %}disabled{% endif %}>
                    <i class="bi bi-trash"></i> Delete
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveImageName()"
                    {% if item_perms and not item_perms.can_edit_upload %}disabled{% endif %}>
                    <i class="bi bi-save"></i> Save Name
                </button>
            </div>
        </div>
    </div>
</div>

<!-- File Rename Modal -->
<div class="modal fade" id="fileRenameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rename File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">File Name:</label>
                    <input type="text" id="fileNameInput" class="form-control" value="">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveFileName()"
                    {% if item_perms and not item_perms.can_edit_upload %}disabled{% endif %}>
                    <i class="bi bi-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // File management functions
    let currentAttachmentId = null;
    let imageEditModalInstance = null;
    let fileRenameModalInstance = null;
    
    // Permission variables from backend
    const canEditUpload = {{ 'true' if item_perms and item_perms.can_edit_upload else 'false' }};

    // Initialize modals
    document.addEventListener('DOMContentLoaded', function () {
        const imageEditModalEl = document.getElementById('imageEditModal');
        const fileRenameModalEl = document.getElementById('fileRenameModal');
        if (imageEditModalEl) imageEditModalInstance = new bootstrap.Modal(imageEditModalEl);
        if (fileRenameModalEl) fileRenameModalInstance = new bootstrap.Modal(fileRenameModalEl);
    });

    function openImageEditModal(src, filename, attachmentId) {
        currentAttachmentId = attachmentId;
        document.getElementById('modalImagePreview').src = src;
        document.getElementById('imageFileName').value = filename;
        imageEditModalInstance.show();
    }

    function openFileRenameModal(attachmentId, filename) {
        if (!canEditUpload) {
            alert('You do not have permission to rename files.');
            return;
        }
        currentAttachmentId = attachmentId;
        document.getElementById('fileNameInput').value = filename;
        fileRenameModalInstance.show();
    }

    function saveImageName() {
        if (!canEditUpload) {
            alert('You do not have permission to rename files.');
            return;
        }
        const newName = document.getElementById('imageFileName').value.trim();
        if (!newName) {
            alert('File name cannot be empty!');
            return;
        }
        renameAttachment(currentAttachmentId, newName);
    }

    function saveFileName() {
        if (!canEditUpload) {
            alert('You do not have permission to rename files.');
            return;
        }
        const newName = document.getElementById('fileNameInput').value.trim();
        if (!newName) {
            alert('File name cannot be empty!');
            return;
        }
        renameAttachment(currentAttachmentId, newName);
    }

    function renameAttachment(attachmentId, newName) {
        fetch(`/attachment/${attachmentId}/rename`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ new_name: newName })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('File renamed successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed to rename file'));
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
    }

    function deleteImageFromModal() {
        if (!canEditUpload) {
            alert('You do not have permission to delete files.');
            return;
        }
        if (confirm('Delete this image?')) {
            deleteFile(currentAttachmentId);
        }
    }

    function deleteFile(attachmentId) {
        if (!canEditUpload) {
            alert('You do not have permission to delete files.');
            return;
        }
        if (confirm('Delete this file?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/attachment/${attachmentId}/delete`;

            const csrfToken = document.querySelector('input[name="csrf_token"]');
            if (csrfToken) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = 'csrf_token';
                tokenInput.value = csrfToken.value;
                form.appendChild(tokenInput);
            }

            document.body.appendChild(form);
            form.submit();
        }
    }

    {% if item %}
    function uploadFiles() {
        const fileInput = document.getElementById('fileUploadInput');
        const files = fileInput.files;

        if (files.length === 0) {
            alert('Please select files to upload');
            return;
        }

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
        }

        // Add CSRF token to form data
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        formData.append('csrf_token', csrfToken);

        fetch('{{ url_for("item.upload_attachment", item_id=item.id) }}', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (response.ok) {
                    alert('Files uploaded successfully!');
                    location.reload();
                } else {
                    return response.text().then(text => {
                        alert('Error uploading files: ' + text);
                    });
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
    }
    {% endif %}
</script>

<style>
    .form-label-sm {
        margin-bottom: 0.25rem;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .drawer-picker-grid {
        display: inline-grid;
        gap: 4px;
        padding: 8px;
        border-radius: 4px;
    }

    .drawer-grid-container {
        background: transparent !important;
        border-color: var(--bs-border-color) !important;
        border: 1px solid var(--bs-border-color) !important;
        color: var(--bs-body-color);
    }

    .drawer-cell-picker {
        width: 40px;
        height: 40px;
        border: 1px solid var(--bs-border-color);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        background-color: var(--bs-secondary-bg);
        color: var(--bs-body-color);
        transition: all 0.2s;
        font-size: 0.7rem;
        font-weight: bold;
        user-select: none;
        text-align: center;
    }

    .drawer-cell-picker:hover:not(.unavailable) {
        border-color: var(--bs-primary);
        background-color: var(--bs-primary-bg-subtle);
        transform: scale(1.1);
    }

    .drawer-cell-picker.selected {
        background-color: var(--bs-primary);
        color: #fff;
        border-color: var(--bs-primary);
    }

    .drawer-cell-picker.unavailable {
        background-color: var(--bs-secondary);
        color: var(--bs-secondary-text-emphasis);
        opacity: 0.6;
        cursor: not-allowed;
    }

    .drawer-cell-picker.unavailable:hover {
        transform: none;
        border-color: var(--bs-secondary);
    }
    
    .drawer-cell-picker.no-permission {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }
    
    .drawer-cell-picker.no-permission:hover {
        transform: none;
        border-color: var(--bs-gray-400);
    }
</style>

<script>
    // Racks data with unavailable drawers
    const racksData = {{ racks_data| tojson | safe }};
    
    // Permission check for location editing
    const canEditLocation = {{ 'true' if item_perms and item_perms.can_edit_location else 'false' }};

    // Location type toggle
    const typeGeneral = document.getElementById('type_general');
    const typeDrawer = document.getElementById('type_drawer');
    const generalSection = document.getElementById('general_location_section');
    const drawerSection = document.getElementById('drawer_storage_section');
    const locationSelect = document.getElementById('location_id');
    const rackSelect = document.getElementById('rack_select');
    const drawerInput = document.getElementById('drawer_input');

    typeGeneral.addEventListener('change', toggleLocationType);
    typeDrawer.addEventListener('change', toggleLocationType);

    function toggleLocationType() {
        if (typeGeneral.checked) {
            generalSection.style.display = 'block';
            drawerSection.style.display = 'none';
            if (locationSelect) {
                locationSelect.disabled = false;
                // Restore previously selected location if available
            }
            rackSelect.value = '';
            drawerInput.value = '';
        } else {
            generalSection.style.display = 'none';
            drawerSection.style.display = 'block';
            if (locationSelect) {
                locationSelect.value = '0'; // Set to 0 but don't disable so it submits
                locationSelect.disabled = false; // Keep enabled so form value is submitted
            }
        }
    }

    // Rack selection
    rackSelect.addEventListener('change', updateDrawerGrid);

    function generateDrawerGrid(rows, cols, rackId) {
        const grid = document.getElementById('drawer_grid');
        grid.innerHTML = '';
        grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        grid.style.maxWidth = `${cols * 45}px`;

        // Find rack data to get unavailable drawers
        const rackData = racksData.find(r => r.id === rackId);
        const unavailableDrawers = rackData ? rackData.unavailable_drawers : [];

        for (let r = 1; r <= rows; r++) {
            for (let c = 1; c <= cols; c++) {
                const cell = document.createElement('div');
                const drawerId = `R${r}-C${c}`;
                const isUnavailable = unavailableDrawers.includes(drawerId);

                cell.className = 'drawer-cell-picker';
                if (isUnavailable) {
                    cell.classList.add('unavailable');
                    cell.title = 'This drawer is unavailable';
                }
                
                // Add disabled class if user lacks permission
                if (!canEditLocation) {
                    cell.classList.add('no-permission');
                    cell.title = 'You do not have permission to edit location';
                }
                
                cell.textContent = drawerId;
                cell.dataset.drawer = drawerId;

                if (drawerInput.value === drawerId) {
                    cell.classList.add('selected');
                }

                if (!isUnavailable) {
                    cell.addEventListener('click', function () {
                        // Check permission before allowing drawer selection
                        if (!canEditLocation) {
                            return; // Prevent selection if no permission
                        }
                        grid.querySelectorAll('.drawer-cell-picker').forEach(d => {
                            d.classList.remove('selected');
                        });
                        this.classList.add('selected');
                        drawerInput.value = this.dataset.drawer;
                    });
                }

                grid.appendChild(cell);
            }
        }
    }

    // Location filtering for drawer storage
    function updateStorageRackSelect() {
        const locationFilter = document.getElementById('storage_location_select');
        const rackSelect = document.getElementById('rack_select');
        const selectedLocationId = locationFilter.value;
        
        // Reset drawer grid and input
        document.getElementById('drawer_input').value = '';
        document.getElementById('drawer_picker').style.display = 'none';
        
        // Get all rack options
        const allOptions = Array.from(rackSelect.querySelectorAll('option'));
        
        // Show/hide racks based on location filter
        allOptions.forEach(option => {
            if (option.value === '') {
                option.style.display = 'block';
            } else {
                const rackLocation = String(option.dataset.location || '');
                const filterValue = String(selectedLocationId);
                
                if (filterValue === '') {
                    // Show all racks
                    option.style.display = 'block';
                } else {
                    // Show only racks from selected location
                    option.style.display = rackLocation === filterValue ? 'block' : 'none';
                }
            }
        });
        
        // Reset rack selection
        rackSelect.value = '';
    }

    function updateDrawerGrid() {
        const rackSelect = document.getElementById('rack_select');
        const selected = rackSelect.options[rackSelect.selectedIndex];
        const drawerPicker = document.getElementById('drawer_picker');

        if (rackSelect.value) {
            const rows = parseInt(selected.dataset.rows);
            const cols = parseInt(selected.dataset.cols);
            const rackId = parseInt(rackSelect.value);

            generateDrawerGrid(rows, cols, rackId);
            drawerPicker.style.display = 'block';
        } else {
            drawerPicker.style.display = 'none';
            document.getElementById('drawer_input').value = '';
        }
    }

    // Lending validation
    const lendToInput = document.getElementById('lend_to_input');
    const lendQtySection = document.getElementById('lend_qty_section');
    const lendQtyInput = document.getElementById('lend_qty_input');
    const lendError = document.getElementById('lend_error');
    const qtyInput = document.getElementById('quantity');

    lendToInput.addEventListener('input', function () {
        if (this.value.trim()) {
            lendQtySection.style.display = 'block';
        } else {
            lendQtySection.style.display = 'none';
            lendQtyInput.value = 0;
        }
    });

    lendQtyInput.addEventListener('input', function () {
        const total = parseInt(qtyInput.value) || 0;
        const lent = parseInt(this.value) || 0;

        if (lent > total) {
            lendError.textContent = `Cannot lend more than ${total}`;
            this.value = total;
        } else {
            lendError.textContent = '';
        }
    });

    // Trigger on page load
    toggleLocationType();
    if (rackSelect.value) {
        rackSelect.dispatchEvent(new Event('change'));
    }
    if (lendToInput.value && lendToInput.value.trim()) {
        lendQtySection.style.display = 'block';
    }

    // Calculate Total Price
    const pricePerQtyInput = document.getElementById('price_per_qty');
    const totalPriceInput = document.getElementById('total_price');

    function calculateTotalPrice() {
        const pricePerQty = parseFloat(pricePerQtyInput.value) || 0;
        const quantity = parseInt(qtyInput.value) || 0;
        const totalPrice = pricePerQty * quantity;
        totalPriceInput.value = totalPrice.toFixed(2);
    }

    pricePerQtyInput.addEventListener('input', calculateTotalPrice);
    qtyInput.addEventListener('input', calculateTotalPrice);

    // Calculate on page load
    calculateTotalPrice();
</script>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Category Name *</label>
                    <input type="text" class="form-control" id="newCategoryName" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="newCategoryDesc" rows="2"></textarea>
                </div>
                <div id="categoryError" class="alert alert-danger d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addCategory()">Add Category</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Footprint Modal -->
<div class="modal fade" id="addFootprintModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Footprint</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Footprint Name *</label>
                    <input type="text" class="form-control" id="newFootprintName" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="newFootprintDesc" rows="2"></textarea>
                </div>
                <div id="footprintError" class="alert alert-danger d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addFootprint()">Add Footprint</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Tag Modal -->
<div class="modal fade" id="addTagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Tag</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Tag Name *</label>
                    <input type="text" class="form-control" id="newTagName" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Color</label>
                    <input type="color" class="form-control form-control-color" id="newTagColor" value="#6c757d">
                </div>
                <div id="tagError" class="alert alert-danger d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addTag()">Add Tag</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Location Modal -->
<div class="modal fade" id="addLocationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New General Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Location Name *</label>
                    <input type="text" class="form-control" id="newLocationName" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Info (Short)</label>
                    <input type="text" class="form-control" id="newLocationInfo" maxlength="500">
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="newLocationDesc" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Color</label>
                    <input type="color" class="form-control form-control-color" id="newLocationColor" value="#6c757d">
                </div>
                <div id="locationError" class="alert alert-danger d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="addLocation()">Add Location</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Add Category
    function addCategory() {
        const name = document.getElementById('newCategoryName').value.trim();
        const description = document.getElementById('newCategoryDesc').value.trim();

        if (!name) {
            showError('categoryError', 'Category name is required');
            return;
        }

        fetch('/api/category/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, description: description })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add to dropdown using ID
                    const select = document.getElementById('category_id');
                    if (select) {
                        const option = new Option(data.category.name, data.category.id, true, true);
                        select.add(option);
                    }

                    // Close modal and reset
                    const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('addCategoryModal'));
                    modal.hide();
                    document.getElementById('newCategoryName').value = '';
                    document.getElementById('newCategoryDesc').value = '';
                    hideError('categoryError');
                } else {
                    showError('categoryError', data.error || 'Failed to add category');
                }
            })
            .catch(error => showError('categoryError', 'Error: ' + error));
    }

    // Add Footprint
    function addFootprint() {
        const name = document.getElementById('newFootprintName').value.trim();
        const description = document.getElementById('newFootprintDesc').value.trim();

        console.log('Adding footprint:', name);

        if (!name) {
            showError('footprintError', 'Footprint name is required');
            return;
        }

        fetch('/api/footprint/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, description: description })
        })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);

                if (data.success) {
                    // Add to dropdown using ID
                    const select = document.getElementById('footprint_id');
                    console.log('Footprint select element:', select);

                    if (select) {
                        const option = new Option(data.footprint.name, data.footprint.id, true, true);
                        select.add(option);
                        console.log('Added footprint to dropdown:', data.footprint.name);
                    } else {
                        console.error('Footprint select element not found!');
                    }

                    // Close modal and reset
                    const modalEl = document.getElementById('addFootprintModal');
                    console.log('Modal element:', modalEl);

                    if (modalEl) {
                        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                        modal.hide();
                        console.log('Modal closed');
                    }

                    document.getElementById('newFootprintName').value = '';
                    document.getElementById('newFootprintDesc').value = '';
                    hideError('footprintError');
                } else {
                    console.error('API returned error:', data.error);
                    showError('footprintError', data.error || 'Failed to add footprint');
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                showError('footprintError', 'Error: ' + error);
            });
    }

    // Add Tag
    function addTag() {
        const name = document.getElementById('newTagName').value.trim();
        const color = document.getElementById('newTagColor').value;

        console.log('Adding tag:', name, 'with color:', color);

        if (!name) {
            showError('tagError', 'Tag name is required');
            return;
        }

        fetch('/api/tag/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, color: color })
        })
            .then(response => {
                console.log('Tag response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Tag response data:', data);

                if (data.success) {
                    // Add to tags container
                    const container = document.getElementById('tagsContainer');
                    console.log('Tags container element:', container);

                    if (!container) {
                        console.error('Tags container not found!');
                        showError('tagError', 'Tags container not found');
                        return;
                    }

                    const newTag = `
                <div class="form-check form-check-inline" style="min-width: 150px;">
                    <input class="form-check-input" type="checkbox" name="tags[]" 
                           value="${data.tag.id}" id="tag${data.tag.id}" checked>
                    <label class="form-check-label" for="tag${data.tag.id}">
                        <span class="badge" style="background-color: ${data.tag.color}; font-size: 0.75rem;">${data.tag.name}</span>
                    </label>
                </div>
            `;
                    container.insertAdjacentHTML('beforeend', newTag);
                    console.log('Added tag to container:', data.tag.name);

                    // Close modal and reset
                    const modalEl = document.getElementById('addTagModal');
                    console.log('Tag modal element:', modalEl);

                    if (modalEl) {
                        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                        modal.hide();
                        console.log('Tag modal closed');
                    }

                    document.getElementById('newTagName').value = '';
                    document.getElementById('newTagColor').value = '#6c757d';
                    hideError('tagError');
                } else {
                    console.error('Tag API returned error:', data.error);
                    showError('tagError', data.error || 'Failed to add tag');
                }
            })
            .catch(error => {
                console.error('Tag fetch error:', error);
                showError('tagError', 'Error: ' + error);
            });
    }

    // Add Location
    function addLocation() {
        const name = document.getElementById('newLocationName').value.trim();
        const info = document.getElementById('newLocationInfo').value.trim();
        const description = document.getElementById('newLocationDesc').value.trim();
        const color = document.getElementById('newLocationColor').value;

        if (!name) {
            showError('locationError', 'Location name is required');
            return;
        }

        fetch('/api/location/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, info: info, description: description, color: color })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add to dropdown
                    const select = document.getElementById('location_id');
                    if (select) {
                        const option = new Option(data.location.name, data.location.id, true, true);
                        select.add(option);
                    }

                    // Close modal and reset
                    const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('addLocationModal'));
                    modal.hide();
                    document.getElementById('newLocationName').value = '';
                    document.getElementById('newLocationInfo').value = '';
                    document.getElementById('newLocationDesc').value = '';
                    document.getElementById('newLocationColor').value = '#6c757d';
                    hideError('locationError');
                } else {
                    showError('locationError', data.error || 'Failed to add location');
                }
            })
            .catch(error => {
                showError('locationError', 'Error: ' + error);
            });
    }

    function showError(id, message) {
        const errorDiv = document.getElementById(id);
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('d-none');
        } else {
            console.error('Error element not found:', id);
            alert(message);
        }
    }

    function hideError(id) {
        const errorDiv = document.getElementById(id);
        if (errorDiv) {
            errorDiv.classList.add('d-none');
        }
    }
</script>

<!-- Add Parameter Modal -->
{% if item %}
<div class="modal fade" id="addParameterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('item.item_add_parameter', id=item.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">Add Magic Parameter</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Parameter Type Selection -->
                    <div class="mb-3">
                        <label class="form-label">Parameter Type</label>
                        <select name="param_type" id="modal_param_type" class="form-select"
                            onchange="updateParameterFields()">
                            <option value="">-- Select Type --</option>
                            <option value="number">Number</option>
                            <option value="date">Date</option>
                            <option value="string">String</option>
                        </select>
                    </div>

                    <!-- Parameter Selection -->
                    <div class="mb-3">
                        <label class="form-label">Parameter</label>
                        <select name="parameter_id" id="modal_parameter_id" class="form-select"
                            onchange="updateParameterOptions()">
                            <option value="">-- Select Parameter --</option>
                        </select>
                    </div>

                    <!-- Operation Selection (for Number and Date types) -->
                    <div class="mb-3" id="operation_group" style="display: none;">
                        <label class="form-label">Operation</label>
                        <select name="operation" id="modal_operation" class="form-select"
                            onchange="updateValueFields()">
                            <option value="">-- Select Operation --</option>
                        </select>
                    </div>

                    <!-- Value Fields -->
                    <div class="row" id="value_fields" style="display: none;">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label" id="value1_label">Value</label>
                                <input type="text" name="value" id="modal_value" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6" id="value2_group" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label" id="value2_label">Second Value</label>
                                <input type="text" name="value2" id="modal_value2" class="form-control">
                            </div>
                        </div>
                    </div>

                    <!-- Unit Selection (for Number type) -->
                    <div class="mb-3" id="unit_group" style="display: none;">
                        <label class="form-label">Unit</label>
                        <select name="unit" id="modal_unit" class="form-select">
                            <option value="">-- Select Unit --</option>
                        </select>
                    </div>

                    <!-- String Option Selection (for String type) -->
                    <div class="mb-3" id="string_option_group" style="display: none;">
                        <label class="form-label">Option</label>
                        <select name="string_option" id="modal_string_option" class="form-select">
                            <option value="">-- Select Option --</option>
                        </select>
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        <textarea name="description" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Parameter</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script>
    // Magic Parameters Functions
    function updateParameterFields() {
        const paramType = document.getElementById('modal_param_type').value;
        const paramSelect = document.getElementById('modal_parameter_id');

        // Clear parameter options
        paramSelect.innerHTML = '<option value="">-- Select Parameter --</option>';

        // Hide all conditional fields
        document.getElementById('operation_group').style.display = 'none';
        document.getElementById('value_fields').style.display = 'none';
        document.getElementById('unit_group').style.display = 'none';
        document.getElementById('string_option_group').style.display = 'none';

        if (paramType) {
            // Fetch parameters for selected type
            fetch(`/api/magic-parameters/${paramType}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(param => {
                        const option = new Option(param.name, param.id);
                        paramSelect.add(option);
                    });
                });
        }
    }

    function updateParameterOptions() {
        const paramType = document.getElementById('modal_param_type').value;
        const parameterId = document.getElementById('modal_parameter_id').value;

        if (!parameterId) return;

        // Show relevant fields based on parameter type
        if (paramType === 'number') {
            // Show operation and unit fields
            document.getElementById('operation_group').style.display = 'block';
            const operationSelect = document.getElementById('modal_operation');
            operationSelect.innerHTML = `
            <option value="">-- Select Operation --</option>
            <option value="min">Min</option>
            <option value="max">Max</option>
            <option value="value">Value</option>
            <option value="range">Range</option>
        `;

            // Fetch and populate units
            fetch(`/api/magic-parameters/number`)
                .then(response => response.json())
                .then(data => {
                    const param = data.find(p => p.id == parameterId);
                    if (param && param.units) {
                        const unitSelect = document.getElementById('modal_unit');
                        unitSelect.innerHTML = '<option value="">-- Select Unit --</option>';
                        param.units.forEach(unit => {
                            const option = new Option(unit, unit);
                            unitSelect.add(option);
                        });
                        document.getElementById('unit_group').style.display = 'block';
                    }
                });
        } else if (paramType === 'date') {
            // Show operation fields with date-specific labels
            document.getElementById('operation_group').style.display = 'block';
            const operationSelect = document.getElementById('modal_operation');
            operationSelect.innerHTML = `
            <option value="">-- Select Operation --</option>
            <option value="start">Start</option>
            <option value="end">End</option>
            <option value="value">Value</option>
            <option value="duration">Duration</option>
        `;
        } else if (paramType === 'string') {
            // Show string options
            fetch(`/api/magic-parameters/string`)
                .then(response => response.json())
                .then(data => {
                    const param = data.find(p => p.id == parameterId);
                    if (param && param.options) {
                        const optionSelect = document.getElementById('modal_string_option');
                        optionSelect.innerHTML = '<option value="">-- Select Option --</option>';
                        param.options.forEach(opt => {
                            const option = new Option(opt, opt);
                            optionSelect.add(option);
                        });
                        document.getElementById('string_option_group').style.display = 'block';
                    }
                });
        }
    }

    function updateValueFields() {
        const paramType = document.getElementById('modal_param_type').value;
        const operation = document.getElementById('modal_operation').value;

        if (!operation) {
            document.getElementById('value_fields').style.display = 'none';
            return;
        }

        document.getElementById('value_fields').style.display = 'block';

        if (paramType === 'date') {
            // Set input type to date
            document.getElementById('modal_value').type = 'date';
            document.getElementById('modal_value2').type = 'date';

            if (operation === 'duration') {
                document.getElementById('value1_label').textContent = 'Start Date';
                document.getElementById('value2_label').textContent = 'End Date';
                document.getElementById('value2_group').style.display = 'block';
            } else {
                document.getElementById('value1_label').textContent = 'Date';
                document.getElementById('value2_group').style.display = 'none';
            }
        } else if (paramType === 'number') {
            // Set input type to text for numbers
            document.getElementById('modal_value').type = 'text';
            document.getElementById('modal_value2').type = 'text';

            if (operation === 'range') {
                document.getElementById('value1_label').textContent = 'Min Value';
                document.getElementById('value2_label').textContent = 'Max Value';
                document.getElementById('value2_group').style.display = 'block';
            } else {
                document.getElementById('value1_label').textContent = 'Value';
                document.getElementById('value2_group').style.display = 'none';
            }
        }
    }
</script>
{% endif %}

<!-- Use Template Modal -->
{% if item %}
<div class="modal fade" id="useTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('item.item_populate_template', id=item.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">Use Parameter Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Template</label>
                        <select name="template_id" id="template_select" class="form-select"
                            onchange="showTemplateDetails()" required>
                            <option value="">-- Select Template --</option>
                        </select>
                    </div>

                    <div id="template_details" style="display: none;">
                        <div class="alert alert-info">
                            <h6 class="mb-2">Template Description:</h6>
                            <p id="template_description" class="mb-0"></p>
                        </div>
                        <div class="card">
                            <div class="card-header">Parameters in this template:</div>
                            <div class="card-body">
                                <ul id="template_parameters" class="list-unstyled mb-0"></ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Populate</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Load templates when modal opens
    document.getElementById('useTemplateModal').addEventListener('show.bs.modal', function () {
        fetch('/api/parameter-templates')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('template_select');
                select.innerHTML = '<option value="">-- Select Template --</option>';
                data.forEach(template => {
                    const option = new Option(template.name, template.id);
                    option.dataset.description = template.description || 'No description';
                    option.dataset.parameters = JSON.stringify(template.parameters);
                    select.add(option);
                });
            });
    });

    function showTemplateDetails() {
        const select = document.getElementById('template_select');
        const selectedOption = select.options[select.selectedIndex];

        if (selectedOption.value) {
            document.getElementById('template_details').style.display = 'block';
            document.getElementById('template_description').textContent = selectedOption.dataset.description;

            const parameters = JSON.parse(selectedOption.dataset.parameters || '[]');
            const paramList = document.getElementById('template_parameters');
            paramList.innerHTML = '';

            if (parameters.length > 0) {
                parameters.forEach(param => {
                    const li = document.createElement('li');
                    li.innerHTML = '<small class="text-muted"> ' + param.display_text + '</small>';
                    paramList.appendChild(li);
                });
            } else {
                paramList.innerHTML = '<li class="text-muted">No parameters in this template</li>';
            }
        } else {
            document.getElementById('template_details').style.display = 'none';
        }
    }
</script>
{% endif %}

{% endblock %}