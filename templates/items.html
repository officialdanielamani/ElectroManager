{% extends "base.html" %}

{% block title %}Items - Inventory Manager{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h2><i class="bi bi-box"></i> Items</h2>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary" style="color: white !important;">
            <div class="card-body">
                <h5 class="card-title" style="color: white !important; font-size: 1.25rem;"><i class="bi bi-box"></i> Total Items</h5>
                <h2 style="color: white !important; font-size: 2.5rem; font-weight: 500;">{{ total_items }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning" style="color: white !important;">
            <div class="card-body">
                <h5 class="card-title" style="color: white !important; font-size: 1.25rem;"><i class="bi bi-exclamation-triangle"></i> Low Stock</h5>
                <h2 style="color: white !important; font-size: 2.5rem; font-weight: 500;">{{ low_stock_items }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger" style="color: white !important;">
            <div class="card-body">
                <h5 class="card-title" style="color: white !important; font-size: 1.25rem;"><i class="bi bi-x-circle"></i> No Stock</h5>
                <h2 style="color: white !important; font-size: 2.5rem; font-weight: 500;">{{ no_stock_items }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success" style="color: white !important;">
            <div class="card-body">
                <h5 class="card-title" style="color: white !important; font-size: 1.25rem;"><i class="bi bi-tags"></i> Categories</h5>
                <h2 style="color: white !important; font-size: 2.5rem; font-weight: 500;">{{ total_categories }}</h2>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" action="{{ url_for('items') }}" class="row g-3">
                    <div class="col-md-5">
                        <input type="text" name="search" class="form-control" placeholder="Search items..." value="{{ search_query }}">
                    </div>
                    <div class="col-md-4">
                        <select name="category" class="form-select">
                            <option value="0">All Categories</option>
                            {% for cat in search_form.category.choices[1:] %}
                            <option value="{{ cat[0] }}" {% if cat[0] == category_id %}selected{% endif %}>{{ cat[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> Search</button>
                        <a href="{{ url_for('items') }}" class="btn btn-secondary"><i class="bi bi-x-circle"></i> Clear</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <!-- Left side: Title and Action Buttons -->
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <h5 class="mb-0 me-2"><i class="bi bi-list-ul"></i> Items</h5>
                        {% if current_user.has_permission('items', 'create') %}
                        <a href="{{ url_for('item_new') }}" class="btn btn-success btn-sm">
                            <i class="bi bi-plus-circle"></i> Add New Item
                        </a>
                        {% endif %}
                        <button class="btn btn-primary btn-sm" disabled>
                            <i class="bi bi-pencil-square"></i> Bulk Edit
                        </button>
                        <button class="btn btn-secondary btn-sm" disabled>
                            <i class="bi bi-qr-code"></i> Bulk Print QR
                        </button>
                    </div>
                    
                    <!-- Right side: View Controls -->
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <div class="d-flex align-items-center gap-2">
                            <label class="mb-0 small">Items Per Page:</label>
                            <select class="form-select form-select-sm" id="itemsPerPage" style="width: auto;" onchange="changeItemsPerPage()">
                                <option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
                                <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                                <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                                <option value="all" {% if per_page == 999999 %}selected{% endif %}>All</option>
                            </select>
                        </div>
                        
                        <div class="d-flex align-items-center gap-1">
                            <label class="mb-0 small me-1">View:</label>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary active" id="viewTable">
                                    <i class="bi bi-list-ul"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="viewCard">
                                    <i class="bi bi-grid-3x2-gap"></i>
                                </button>
                            </div>
                        </div>
                        
                        <button class="btn btn-secondary btn-sm" onclick="printItemsList()">
                            <i class="bi bi-printer"></i> Print This List
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body" style="min-height: 420px;">
                {% if items %}
                <!-- Table View Container -->
                <div id="tableViewContainer" data-view="table">
                <!-- Table View -->
                <div id="tableView" class="table-responsive">
                    <table class="table table-hover" id="itemTable">
                        <thead>
                            <tr>
                                <th width="30">
                                    <input type="checkbox" id="selectAll" title="Select All">
                                </th>
                                <th>
                                    <a href="#" class="text-decoration-none" title="Sort by Name">
                                        Name
                                        <i class="bi bi-arrow-down-up text-muted sort-default"></i>
                                    </a>
                                </th>
                                {% for col in user_columns %}
                                    {% if col == 'type_model' %}
                                        <th>
                                            <a href="#" class="text-decoration-none" title="Sort by Type/Model">
                                                Type/Model
                                                <i class="bi bi-arrow-down-up text-muted sort-default"></i>
                                            </a>
                                        </th>
                                    {% endif %}
                                    {% if col == 'sku' %}
                                        <th>
                                            <a href="#" class="text-decoration-none" title="Sort by SKU">
                                                SKU
                                                <i class="bi bi-arrow-down-up text-muted sort-default"></i>
                                            </a>
                                        </th>
                                    {% endif %}
                                    {% if col == 'category' %}
                                        <th>
                                            <a href="#" class="text-decoration-none" title="Sort by Category">
                                                Category
                                                <i class="bi bi-arrow-down-up text-muted sort-default"></i>
                                            </a>
                                        </th>
                                    {% endif %}
                                    {% if col == 'tags' %}<th>Tags</th>{% endif %}
                                    {% if col == 'footprint' %}
                                        <th>
                                            <a href="#" class="text-decoration-none" title="Sort by Footprint">
                                                Footprint
                                                <i class="bi bi-arrow-down-up text-muted sort-default"></i>
                                            </a>
                                        </th>
                                    {% endif %}
                                    {% if col == 'quantity' %}
                                        <th>
                                            <a href="#" class="text-decoration-none" title="Sort by Quantity">
                                                Quantity
                                                <i class="bi bi-arrow-down-up text-muted sort-default"></i>
                                            </a>
                                        </th>
                                    {% endif %}
                                    {% if col == 'total_price' %}
                                        <th>
                                            <a href="#" class="text-decoration-none" title="Sort by Total Price">
                                                Total Price
                                                <i class="bi bi-arrow-down-up text-muted sort-default"></i>
                                            </a>
                                        </th>
                                    {% endif %}
                                    {% if col == 'price_per_unit' %}
                                        <th>
                                            <a href="#" class="text-decoration-none" title="Sort by Price Per Unit">
                                                Price Per Unit
                                                <i class="bi bi-arrow-down-up text-muted sort-default"></i>
                                            </a>
                                        </th>
                                    {% endif %}
                                    {% if col == 'min_quantity' %}
                                        <th>
                                            <a href="#" class="text-decoration-none" title="Sort by Min Quantity">
                                                Min Quantity
                                                <i class="bi bi-arrow-down-up text-muted sort-default"></i>
                                            </a>
                                        </th>
                                    {% endif %}
                                    {% if col == 'location' %}
                                        <th>
                                            <a href="#" class="text-decoration-none" title="Sort by Location">
                                                Location
                                                <i class="bi bi-arrow-down-up text-muted sort-default"></i>
                                            </a>
                                        </th>
                                    {% endif %}
                                    {% if col == 'uuid' %}
                                        <th>
                                            <a href="#" class="text-decoration-none" title="Item UUID">
                                                UUID
                                                <i class="bi bi-arrow-down-up text-muted sort-default"></i>
                                            </a>
                                        </th>
                                    {% endif %}
                                    {% if col == 'updated_at' %}
                                        <th>
                                            <a href="#" class="text-decoration-none" title="Sort by Last Updated">
                                                Last Updated
                                                <i class="bi bi-arrow-down-up text-muted sort-default"></i>
                                            </a>
                                        </th>
                                    {% endif %}
                                    {% if col == 'status' %}
                                        <th>
                                            <div class="dropdown d-inline-block">
                                                <button class="btn btn-link text-decoration-none dropdown-toggle p-0 border-0" data-bs-toggle="dropdown" title="Filter by Status" style="color: inherit;">
                                                    Status
                                                    <i class="bi bi-funnel text-muted"></i>
                                                </button>
                                                <div class="dropdown-menu" style="min-width: 220px;" onclick="event.stopPropagation();">
                                                    <div class="dropdown-header">
                                                        <small><strong>Filter by Status</strong></small>
                                                    </div>
                                                    <div class="dropdown-divider m-0"></div>
                                                    <div class="p-2">
                                                        <div class="form-check">
                                                            <input class="form-check-input status-filter" type="checkbox" id="status_ok" value="ok" onchange="liveApplyStatusFilter()" {% if 'ok' in status_filter %}checked{% endif %}>
                                                            <label class="form-check-label ms-1" for="status_ok" style="cursor: pointer;">
                                                                <span class="badge bg-success">OK</span>
                                                            </label>
                                                        </div>
                                                        <div class="form-check mt-2">
                                                            <input class="form-check-input status-filter" type="checkbox" id="status_low" value="low" onchange="liveApplyStatusFilter()" {% if 'low' in status_filter %}checked{% endif %}>
                                                            <label class="form-check-label ms-1" for="status_low" style="cursor: pointer;">
                                                                <span class="badge bg-warning">Low Stock</span>
                                                            </label>
                                                        </div>
                                                        <div class="form-check mt-2">
                                                            <input class="form-check-input status-filter" type="checkbox" id="status_no" value="no" onchange="liveApplyStatusFilter()" {% if 'no' in status_filter %}checked{% endif %}>
                                                            <label class="form-check-label ms-1" for="status_no" style="cursor: pointer;">
                                                                <span class="badge bg-danger">No Stock</span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </th>
                                    {% endif %}
                                {% endfor %}
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="item-checkbox" value="{{ item.id }}">
                                </td>
                                <td>
                                    <a href="{{ url_for('item_detail', uuid=item.uuid) }}">{{ item.name }}</a>
                                </td>
                                {% for col in user_columns %}
                                    {% if col == 'type_model' %}
                                    <td>{{ item.info or '-' }}</td>
                                    {% endif %}
                                    {% if col == 'sku' %}
                                    <td>{{ item.sku or '-' }}</td>
                                    {% endif %}
                                    {% if col == 'category' %}
                                    <td>
                                        {% if item.category %}
                                        <span class="badge" style="background-color: {{ item.category.color }}; color: white;">
                                            {{ item.category.name }}
                                        </span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                    {% if col == 'tags' %}
                                    <td>
                                        {% for tag in item.get_tags_list() %}
                                        <span class="badge" style="background-color: {{ tag.color }}; color: white;">{{ tag.name }}</span>
                                        {% endfor %}
                                        {% if not item.get_tags_list() %}-{% endif %}
                                    </td>
                                    {% endif %}
                                    {% if col == 'footprint' %}
                                    <td>
                                        {% if item.footprint %}
                                        {{ item.footprint.name }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                    {% if col == 'quantity' %}
                                    <td>{{ item.quantity }}</td>
                                    {% endif %}
                                    {% if col == 'total_price' %}
                                    <td>
                                        {% if item.get_total_price() %}
                                        {{ currency_symbol }}{{ item.get_total_price()|format_amount(currency_decimal_places) }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                    {% if col == 'price_per_unit' %}
                                    <td>
                                        {% if item.price %}
                                        {{ currency_symbol }}{{ item.price|format_amount(currency_decimal_places) }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                    {% if col == 'min_quantity' %}
                                    <td>{{ item.min_quantity if item.min_quantity is not none else '-' }}</td>
                                    {% endif %}
                                    {% if col == 'location' %}
                                    <td>
                                        {% if item.rack and item.drawer %}
                                        {{ item.rack.name }} - {{ item.drawer }}
                                        {% elif item.location %}
                                        {{ item.location.name }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                    {% if col == 'uuid' %}
                                    <td>
                                        <code style="font-size: 0.9rem; background-color: #f5f5f5; padding: 2px 6px; border-radius: 3px;">
                                            {{ item.uuid }}
                                        </code>
                                    </td>
                                    {% endif %}
                                    {% if col == 'updated_at' %}
                                    <td>{{ item.updated_at.strftime('%Y-%m-%d %H:%M') if item.updated_at else '-' }}</td>
                                    {% endif %}
                                    {% if col == 'status' %}
                                    <td>
                                        {% if item.is_no_stock() %}
                                            <span class="badge bg-danger">No Stock</span>
                                        {% elif item.is_low_stock() %}
                                            <span class="badge bg-warning">Low Stock</span>
                                        {% else %}
                                            <span class="badge bg-success">OK</span>
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                {% endfor %}
                                <td>
                                    <!-- View button (only if has view permission) -->
                                    {% if current_user.has_permission('items', 'view') %}
                                    <a href="{{ url_for('item_detail', uuid=item.uuid) }}" class="btn btn-sm btn-info" title="View">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    {% endif %}
                                    
                                    <!-- Edit button (if has any edit permission) -->
                                    {% if current_user.has_permission('items', 'edit_name') or current_user.has_permission('items', 'edit_sku_type') or current_user.has_permission('items', 'edit_description') or current_user.has_permission('items', 'edit_datasheet') or current_user.has_permission('items', 'edit_upload') or current_user.has_permission('items', 'edit_lending') or current_user.has_permission('items', 'edit_price') or current_user.has_permission('items', 'edit_quantity') or current_user.has_permission('items', 'edit_location') or current_user.has_permission('items', 'edit_category') or current_user.has_permission('items', 'edit_footprint') or current_user.has_permission('items', 'edit_tags') or current_user.has_permission('items', 'edit_parameters') %}
                                    <a href="{{ url_for('item_edit', uuid=item.uuid) }}" class="btn btn-sm btn-warning" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    {% endif %}
                                    
                                    <!-- Delete button (if has delete permission) -->
                                    {% if current_user.has_permission('items', 'delete') %}
                                    <form method="POST" action="{{ url_for('item_delete', uuid=item.uuid) }}" style="display:inline">
                                        <button type="submit" class="btn btn-sm btn-danger" title="Delete" onclick="return confirm('Delete this item?')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                    
                                    <!-- Show dash if no permissions -->
                                    {% if not (current_user.has_permission('items', 'view') or current_user.has_permission('items', 'edit_name') or current_user.has_permission('items', 'edit_sku_type') or current_user.has_permission('items', 'edit_description') or current_user.has_permission('items', 'edit_datasheet') or current_user.has_permission('items', 'edit_upload') or current_user.has_permission('items', 'edit_lending') or current_user.has_permission('items', 'edit_price') or current_user.has_permission('items', 'edit_quantity') or current_user.has_permission('items', 'edit_location') or current_user.has_permission('items', 'edit_category') or current_user.has_permission('items', 'edit_footprint') or current_user.has_permission('items', 'edit_tags') or current_user.has_permission('items', 'edit_parameters') or current_user.has_permission('items', 'delete')) %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                </div>
                <!-- End Table View Container -->

                <!-- Card View Container -->
                <div id="cardViewContainer" data-view="card" style="display: none;">
                <!-- Card View -->
                <div id="cardView" class="row g-2 justify-content-center">
                    {% for item in items %}
                    <div class="col-12 col-sm-6 col-md-3 col-lg-2-4 col-xl-2-4">
                        <div class="card h-100 border">
                            <div class="card-header p-2">
                                <h6 class="mb-0 text-truncate" title="{{ item.name }}" text-align="center">
                                    <strong>{{ item.name }}</strong>
                                </h6>
                            </div>
                            <div class="card-body p-2">
                                <p class="mb-1 small"><strong>Model:</strong> {{ item.info or '-' }}</p>
                                <p class="mb-1 small"><strong>SKU:</strong> {{ item.sku or '-' }}</p>
                                <p class="mb-1 small">
                                    <strong>Category:</strong> 
                                    {% if item.category %}
                                    <span class="badge" style="background-color: {{ item.category.color }}; color: white; font-size: 0.7rem;">{{ item.category.name }}</span>
                                    {% else %}-{% endif %}
                                </p>
                                <p class="mb-2 small text-muted">{{ item.uuid }}</p>
                                
                                <hr class="my-2">
                                
                                <!-- Picture -->
                                <div class="text-center mb-2 border rounded" style="height: 180px; width: 100%; overflow: hidden; background-color: #f5f5f5;">
                                    {% set image_found = false %}
                                    {% for attachment in item.attachments %}
                                        {% if not image_found and attachment.file_type and attachment.file_type in ['png', 'jpg', 'jpeg', 'gif', 'webp'] %}
                                            <img src="{{ url_for('uploaded_file', filename=attachment.filename) }}" 
                                                 alt="{{ item.name }}" 
                                                 style="max-width: 100%; max-height: 100%; width: 100%; height: 100%; object-fit: contain; display: block;">
                                            {% set image_found = true %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if not image_found %}
                                    <div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">
                                        <i class="bi bi-image text-muted" style="font-size: 2.5rem;"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <hr class="my-2">
                                
                                <p class="mb-1 small">
                                    <strong>Tags:</strong> 
                                    {% for tag in item.get_tags_list() %}
                                    <span class="badge" style="background-color: {{ tag.color }}; color: white; font-size: 0.65rem;">{{ tag.name }}</span>
                                    {% endfor %}
                                    {% if not item.get_tags_list() %}-{% endif %}
                                </p>
                                <p class="mb-1 small">
                                    <strong>Footprint:</strong> {{ item.footprint.name if item.footprint else '-' }}
                                </p>
                                <p class="mb-1 small">
                                    <strong>Location:</strong> 
                                    {% if item.rack and item.drawer %}
                                    {{ item.rack.name }} - {{ item.drawer }}
                                    {% elif item.location %}
                                    {{ item.location.name }}
                                    {% else %}-{% endif %}
                                </p>
                                <p class="mb-1 small">
                                    <strong>Quantity:</strong> {{ item.quantity }}
                                    {% if item.is_no_stock() %}
                                    <span class="badge bg-danger" style="font-size: 0.65rem;">No Stock</span>
                                    {% elif item.is_low_stock() %}
                                    <span class="badge bg-warning" style="font-size: 0.65rem;">Low</span>
                                    {% else %}
                                    <span class="badge bg-success" style="font-size: 0.65rem;">OK</span>
                                    {% endif %}
                                </p>
                                <p class="mb-1 small"><strong>Price/Unit:</strong> {{ currency_symbol }}{{ item.price|format_amount(currency_decimal_places) if item.price else '-' }}</p>
                                <p class="mb-2 small"><strong>Total:</strong> {{ currency_symbol }}{{ item.get_total_price()|format_amount(currency_decimal_places) if item.get_total_price() else '-' }}</p>
                                
                                <div class="btn-group btn-group-sm w-100" role="group">
                                    {% if current_user.has_permission('items', 'view') %}
                                    <a href="{{ url_for('item_detail', uuid=item.uuid) }}" class="btn btn-sm btn-info" title="View">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    {% endif %}
                                    {% if current_user.has_permission('items', 'edit_name') or current_user.has_permission('items', 'edit_sku_type') or current_user.has_permission('items', 'edit_description') or current_user.has_permission('items', 'edit_datasheet') or current_user.has_permission('items', 'edit_upload') or current_user.has_permission('items', 'edit_lending') or current_user.has_permission('items', 'edit_price') or current_user.has_permission('items', 'edit_quantity') or current_user.has_permission('items', 'edit_location') or current_user.has_permission('items', 'edit_category') or current_user.has_permission('items', 'edit_footprint') or current_user.has_permission('items', 'edit_tags') or current_user.has_permission('items', 'edit_parameters') %}
                                    <a href="{{ url_for('item_edit', uuid=item.uuid) }}" class="btn btn-sm btn-warning" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    {% endif %}
                                    {% if current_user.has_permission('items', 'delete') %}
                                    <button type="button" class="btn btn-sm btn-danger" title="Delete" onclick="if(confirm('Delete {{ item.name }}?')) { document.getElementById('delete-form-{{ item.id }}').submit(); }">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    <form id="delete-form-{{ item.id }}" method="POST" action="{{ url_for('item_delete', uuid=item.uuid) }}" style="display:none;"></form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                </div>
                <!-- End Card View Container -->

                <!-- Pagination -->
                {% if pagination.pages > 1 %}
                <nav>
                    <ul class="pagination justify-content-center">
                        {% if pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('items', page=pagination.prev_num, search=search_query, category=category_id, status=status_filter, per_page=per_page) }}">Previous</a>
                        </li>
                        {% endif %}

                        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                            {% if page_num %}
                                {% if page_num != pagination.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('items', page=page_num, search=search_query, category=category_id, status=status_filter, per_page=per_page) }}">{{ page_num }}</a>
                                </li>
                                {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% endif %}
                        {% endfor %}

                        {% if pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('items', page=pagination.next_num, search=search_query, category=category_id, status=status_filter, per_page=per_page) }}">Next</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No items found. 
                    {% if current_user.has_permission('items', 'create') %}
                    <a href="{{ url_for('item_new') }}">Add your first item</a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Print items list function
function printItemsList() {
    // Get current URL parameters
    const url = new URL(window.location.href);
    const params = new URLSearchParams(url.search);
    
    // Determine current view type (table or card)
    const viewType = localStorage.getItem('itemsView') || 'table';
    
    // Build print URL with all current parameters
    const printUrl = new URL('{{ url_for("items_print") }}', window.location.origin);
    
    // Copy all query parameters
    for (const [key, value] of params.entries()) {
        printUrl.searchParams.set(key, value);
    }
    
    // Add view type parameter
    printUrl.searchParams.set('view', viewType);
    
    // Open print page in new window
    window.open(printUrl.toString(), '_blank');
}

// Select all checkbox functionality
document.getElementById('selectAll')?.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.item-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
});

// Update select all when individual checkboxes change
document.querySelectorAll('.item-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const allCheckboxes = document.querySelectorAll('.item-checkbox');
        const checkedCount = document.querySelectorAll('.item-checkbox:checked').length;
        document.getElementById('selectAll').checked = checkedCount === allCheckboxes.length;
    });
});

// Live status filter functionality
function liveApplyStatusFilter() {
    const form = document.querySelector('form');
    const selectedStatuses = Array.from(document.querySelectorAll('.status-filter:checked'))
        .map(cb => cb.value)
        .join(',');
    
    // Create a hidden input for status filter
    let statusInput = form.querySelector('input[name="status"]');
    if (!statusInput) {
        statusInput = document.createElement('input');
        statusInput.type = 'hidden';
        statusInput.name = 'status';
        form.appendChild(statusInput);
    }
    statusInput.value = selectedStatuses;
    
    // Submit the form immediately
    form.submit();
}

// Keep old functions for backward compatibility (if needed)
function applyStatusFilter() {
    liveApplyStatusFilter();
}

function clearStatusFilter() {
    document.querySelectorAll('.status-filter').forEach(cb => cb.checked = false);
    liveApplyStatusFilter();
}

// Change items per page
function changeItemsPerPage() {
    const perPage = document.getElementById('itemsPerPage').value;
    const url = new URL(window.location.href);
    
    if (perPage === 'all') {
        url.searchParams.set('per_page', '999999');
    } else {
        url.searchParams.set('per_page', perPage);
    }
    
    // Reset to page 1 when changing items per page
    url.searchParams.set('page', '1');
    
    window.location.href = url.toString();
}

// Toggle between table and card view
function setupViewToggle() {
    document.getElementById('viewTable')?.addEventListener('click', function() {
        const tableContainer = document.getElementById('tableViewContainer');
        const cardContainer = document.getElementById('cardViewContainer');
        
        if (tableContainer) {
            tableContainer.classList.remove('hidden');
        }
        if (cardContainer) {
            cardContainer.classList.remove('visible');
        }
        
        document.getElementById('viewTable').classList.add('active');
        document.getElementById('viewCard').classList.remove('active');
        localStorage.setItem('itemsView', 'table');
    });

    document.getElementById('viewCard')?.addEventListener('click', function() {
        const tableContainer = document.getElementById('tableViewContainer');
        const cardContainer = document.getElementById('cardViewContainer');
        
        if (tableContainer) {
            tableContainer.classList.add('hidden');
        }
        if (cardContainer) {
            cardContainer.classList.add('visible');
        }
        
        document.getElementById('viewCard').classList.add('active');
        document.getElementById('viewTable').classList.remove('active');
        localStorage.setItem('itemsView', 'card');
    });
}

// Setup view toggle immediately
setupViewToggle();

// Restore view preference on page load
document.addEventListener('DOMContentLoaded', function() {
    const savedView = localStorage.getItem('itemsView');
    if (savedView === 'card') {
        document.getElementById('viewCard')?.click();
    }
});
</script>

<script src="{{ url_for('static', filename='js/table-sorter.js') }}"></script>
{% endblock %}
